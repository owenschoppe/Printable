var order=["summary","title","author","url","tags","destination","doc_title","addNote"];var folders=["Citable_Documents","Citation_Tool_Documents"];var bgPage=chrome.extension.getBackgroundPage();var pollIntervalMax=1000*60*60;var requestFailureCount=0;var requestTimeout=1000*2;String.prototype.truncate=function(){var b=this.match(/^.{0,22}[\S]*/);var a=b[0].length;b=b[0].replace(/\s$/,"");if(a<this.length){b=b+"&hellip;"}else{b=this.substr(0,22)+(this.length>23?"&hellip;":"")}return b};gdocs.getLink=function(b,a){for(var c=0,d;d=b[c];++c){if(d.rel===a){return d}}return null};gdocs.getCategory=function(c,b,e){for(var d=0,a;a=c[d];++d){if(e){if(a.scheme===b&&e===a.term){return a}}else{if(a.scheme===b){return a}}}return null};gdocs.GoogleDoc=function(a){this.entry=a;this.title=a.title.$t;this.resourceId=a.gd$resourceId.$t;this.type=gdocs.getCategory(a.category,"http://schemas.google.com/g/2005#kind");this.starred=gdocs.getCategory(a.category,"http://schemas.google.com/g/2005/labels","http://schemas.google.com/g/2005/labels#starred")?true:false;this.link={alternate:gdocs.getLink(a.link,"alternate").href};this.contentSrc=a.content.src};gdocs.Category=function(a){this.entry=a;this.resourceId=a.gd$resourceId.$t};gdocs.changeAction=function(b,c,a){console.log("gdocs.changeAction",b,c,a);document.getElementById("output").firstChild.addClassName("hidden");document.getElementById("elements").innerHTML="";cols=[];$("#loading").removeClass("hidden");docKey=$("#destination").val().split(":")[1];console.log("docKey: ",docKey,a);localStorage.defaultDoc=docKey;localStorage.defaultDocName=a;setTimeout(function(){gdocs.printDocument(null,processRowsCallback)},0);return};gdocs.renderDocSelect=function(g){console.log("gdocs.renderDocSelect");util.hideMsg();var b=[];if(bgPage.docs.length){var e;var c;var d=false;for(var a=0,f;f=bgPage.docs[a];++a){e=f.resourceId.slice(12);c=e==localStorage.defaultDoc?"selected":"";d=c=="selected"?true:d;b.push("<option ",c,' value="',f.resourceId,'">',f.title.truncate(),"</option>")}console.log("found ",d);if(d==false){b.unshift('<option selected value="spreadsheet:',localStorage.defaultDoc,'">'+localStorage.defaultDocName.truncate(),"</option>")}if(bgPage.firstRun==true){console.log("bgPage.firstRun ",bgPage.firstRun);bgPage.updateDocument(bgPage.updateDocumentCallback)}}$("#selection").html('<select id="destination" class="Droid" name="destination">'+b.join("")+"</select>");document.querySelector("#destination").addEventListener("change",gdocs.onChangeHandler);console.log("callback");if(g){g()}};gdocs.onChangeHandler=function(a){gdocs.changeAction(this.form,this.value,$("select option:selected").html())};gdocs.getDocumentList=function(b,g){console.log("gdocs.getDocumentList");var a=function(j,n){console.log("gdocs.getDocumentList handleSuccess",n);if(n.status!=200){gdocs.handleError(n,j);g(n.status);return}else{requestFailureCount=0}var m=JSON.parse(j);console.log("Doc list data. Should have entries. ",m);if(m.feed.entry){console.log("process feed");for(var k=0,l;l=m.feed.entry[k];++k){console.log(k);bgPage.docs.push(new gdocs.GoogleDoc(l))}var h=gdocs.getLink(m.feed.link,"next");if(h){gdocs.getDocumentList(h.href)}else{console.log("render doc list");gdocs.renderDocSelect(g)}}else{console.log("create new document");util.displayMsg("No documents found.");util.hideMsg();gdocs.renderDocSelect(function(){gdocs.changeAction(this.form,"new")})}if(g){g()}};var e=function(){gdocs.changeAction(this.form,"new")};var c=b||null;var f={headers:{"GData-Version":"3.0"},parameters:{alt:"json",showfolders:"true"}};if(!c){c=bgPage.DOCLIST_FEED+bgPage.cat[0].resourceId+"/contents"}else{bgPage.docs=[];var d=c.split("?");if(d.length>1){c=d[0];f.parameters=util.unstringify(d[1])}}bgPage.oauth.sendSignedRequest(c,a,f)};gdocs.constructMoveManyBody_=function(d){console.log("gdocs.constructMoveManyBody");var c=["<?xml version='1.0' encoding='UTF-8'?>"];for(var b,a;a=d[b].resourceId;b++){c+=["<entry xmlns='http://www.w3.org/2005/Atom'>","<id>https://docs.google.com/feeds/default/private/full/",a,"</id>","</entry>"].join("")}return c};gdocs.constructMoveBody_=function(a){var b=["<?xml version='1.0' encoding='UTF-8'?>","<entry xmlns='http://www.w3.org/2005/Atom'>","<id>https://docs.google.com/feeds/default/private/full/",a,"</id>","</entry>"].join("");return b};gdocs.moveDoc=function(e,d){console.log("gdocs.moveDoc");var c=0;var a=function(f,g){console.log("moveDoc handleSuccess: ",g);if(g.status!=201){console.log("ERROR",g);gdocs.handleError(g,f);if(g.status==404){gdocs.createFolder(0,b)}else{return}}else{util.hideMsg();requestFailureCount=0;++c;if(!d&&c<bgPage.docs.length){b()}else{console.log("gdocs.moveDoc handleSuccess -> CALLBACK");e()}}};var b=function(){url=bgPage.DOCLIST_FEED+bgPage.cat[0].resourceId+"/contents";id=d?d:bgPage.docs[c].resourceId;var f={method:"POST",headers:{"GData-Version":"3.0","Content-Type":"application/atom+xml",},parameters:{alt:"json"},body:gdocs.constructMoveBody_(id)};bgPage.oauth.sendSignedRequest(url,a,f);console.log("Move to:",url,f)};if(bgPage.docs.length){b()}};gdocs.constructFolderBody_=function(b){var a=["<?xml version='1.0' encoding='UTF-8'?>","<entry xmlns='http://www.w3.org/2005/Atom'>","<category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/docs/2007#folder' />","<title type='text'>Citable_Documents</title>","</entry>"].join("");return a};gdocs.createFolder=function(c,d){console.log("gdocs.createFolder ",c);var a=function(e,g){console.log("category returned: ",g);if(g.status!=201){console.log("ERROR",g);gdocs.handleError(g,e);return}else{requestFailureCount=0}bgPage.cat.splice(0,bgPage.cat.length,new gdocs.Category(JSON.parse(e).entry));var f=bgPage.cat[0].resourceId.split(":");var h=f[1];console.log("category: ",h," : ",bgPage.cat[0]);d(h)};console.log("Creating folder...");var b={method:"POST",headers:{"GData-Version":"3.0","Content-Type":"application/atom+xml",},parameters:{alt:"json"},body:gdocs.constructFolderBody_(folders[c])};bgPage.oauth.sendSignedRequest(bgPage.DOCLIST_FEED,a,b);console.log("FOLDER:",bgPage.DOCLIST_FEED,b)};gdocs.getFolder=function(c,d){console.log("gdocs.getFolder");var b={headers:{"GData-Version":"3.0"}};var a=function(e,j){console.log("getFolder handleSuccess: ",j);if(j.status!=200){gdocs.handleError(j,e);return}else{requestFailureCount=0}var h=JSON.parse(e);console.log(h);if(h.feed.entry){console.log("parse folders");for(var f=0,g;g=h.feed.entry[f];++f){bgPage.cat.push(new gdocs.Category(g))}console.log("folder Id: ",bgPage.cat[bgPage.cat.length-1].resourceId);d(bgPage.cat[bgPage.cat.length-1].resourceId)}else{d(null)}util.hideMsg()};url=bgPage.DOCLIST_FEED;b.parameters={alt:"json",title:folders[c],showfolders:"true","title-exact":"true"};bgPage.oauth.sendSignedRequest(url,a,b)};gdocs.updateFolders=function(e){console.log("gdocs.updateFolders");var d=function(f){console.log("gdocs.updateFolders createFolderCallback",f);gdocs.getFolder(1,b)};var b=function(f){console.log("gdocs.updateFolders getFolderCallback",f);if(f==null){url=bgPage.DOCLIST_FEED+bgPage.cat[0].resourceId+"/contents";gdocs.getDocumentList(url,gdocs.start.getDocumentListCallback)}else{url=bgPage.DOCLIST_FEED+f+"/contents";gdocs.getDocumentList(url,c)}};var c=function(f){console.log("gdocs.updateFolders getDocListCallback",f);gdocs.moveDoc(a)};var a=function(){console.log("gdocs.updateFolders moveDocCallback");bgPage.docs=[];e()};gdocs.createFolder(0,d)};gdocs.start=function(d){console.log("gdocs.start",d);var c=function(e){console.log("gdocs.start getFolderCallback ",e);if(e==null){gdocs.updateFolders(a)}else{url=bgPage.DOCLIST_FEED+e+"/contents";gdocs.getDocumentList(url,b)}};var b=function(f){if(f){gdocs.getFolder(0,c)}if(d){d()}};var a=function(){console.log("gdocs.start updateFoldersCallback");gdocs.getDocumentList()};console.log("bgPage.cat[0] does not have id");gdocs.getFolder(0,c)};